name: Generate OpenAPI spec and open PR

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/fakeoverflow-api/**'
      - '.github/workflows/generate-openapi-spec.yml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-openapi:
    name: Generate OpenAPI and create PR
    runs-on: ubuntu-latest
    env:
      SOLUTION_PATH: apps/fakeoverflow-api/FakeOverFlow/FakeOverFlow.sln
      API_PROJECT_PATH: apps/fakeoverflow-api/FakeOverFlow/FakeoverFlow.Backend.Http.Api/FakeoverFlow.Backend.Http.Api.csproj
      API_DLL_PATH: apps/fakeoverflow-api/FakeOverFlow/FakeoverFlow.Backend.Http.Api/bin/Release/net9.0/FakeoverFlow.Backend.Http.Api.dll
      OUTPUT_DIR: .specification
      OUTPUT_FILE: fakeoverflow-api.json
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build solution (Release)
        run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration Release

      - name: Install Swashbuckle CLI
        run: dotnet tool install -g Swashbuckle.AspNetCore.Cli

      - name: Generate OpenAPI specification
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ env.OUTPUT_DIR }}"
          
          # Generate OpenAPI spec using Swashbuckle CLI
          swagger tofile --output "${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}" \
            "${{ env.API_DLL_PATH }}" v1
          
          # Pretty-print JSON if jq is available
          if command -v jq >/dev/null 2>&1; then
            jq . "${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}" > temp.json
            mv temp.json "${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}"
          fi
          
          echo "✅ Generated OpenAPI spec at ${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}"
          
          # Show basic info about generated spec
          if command -v jq >/dev/null 2>&1; then
            echo "📊 API Info:"
            jq -r '.info | "Title: \(.title), Version: \(.version)"' "${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}" || true
            echo "🔗 Endpoints: $(jq -r '.paths | keys | length' "${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}" || echo "unknown")"
          fi

      - name: Validate generated specification
        shell: bash
        run: |
          set -euo pipefail
          
          # Basic validation - check if file exists and is valid JSON
          if [ ! -f "${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}" ]; then
            echo "❌ OpenAPI spec file was not generated"
            exit 1
          fi
          
          # Validate JSON syntax
          if command -v jq >/dev/null 2>&1; then
            if ! jq empty "${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}"; then
              echo "❌ Generated OpenAPI spec is not valid JSON"
              exit 1
            fi
          
            # Check for required OpenAPI fields
            if ! jq -e '.openapi' "${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}" >/dev/null; then
              echo "❌ Generated spec missing 'openapi' field"
              exit 1
            fi
          
            echo "✅ OpenAPI specification validation passed"
          else
            echo "⚠️ jq not available, skipping detailed validation"
          fi

      - name: Create Pull Request with updated spec
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(openapi): update generated OpenAPI spec"
          title: "chore(openapi): update generated OpenAPI spec"
          body: |
            ## 🔄 OpenAPI Specification Update
            
            This PR contains an automatically generated update to the OpenAPI specification.
            
            ### 📋 Details
            - **Generated from**: Latest main commit `${{ github.sha }}`
            - **Source**: FastEndpoints .NET 9 API at `apps/fakeoverflow-api`
            - **Method**: Swashbuckle CLI (`swagger tofile`)
            - **Generated at**: ${{ steps.date.outputs.date }}
            
            ### 🛠️ Changes
            - Updated `${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}`
            
            ### 🔍 Review Checklist
            - [ ] Verify new endpoints are documented correctly
            - [ ] Check for any breaking changes in existing endpoints
            - [ ] Ensure response schemas are accurate
            - [ ] Validate authentication/authorization requirements
            
            ---
            *This PR was automatically generated by the OpenAPI specification workflow.*
          branch: chore/update-openapi-spec
          add-paths: |
            ${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}
          signoff: false
          delete-branch: true
          labels: |
            automated
            openapi
            documentation